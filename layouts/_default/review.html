{{ define "main" }}
<main class="reviews-page">
    <header class="reviews-header">
        <h1 class="reviews-title">{{ .Title }}</h1>
        {{ with .Params.description }}<p class="reviews-desc">{{ . }}</p>{{ end }}
    </header>

    <section class="reviews-controls" aria-label="Bangumi filters">
        <div class="reviews-filter">
            <label for="review-min-rate">最低分</label>
            <input id="review-min-rate" type="number" step="1" placeholder="0">
        </div>

        <div class="reviews-filter">
            <label for="review-max-rate">最高分</label>
            <input id="review-max-rate" type="number" step="1" placeholder="5">
        </div>

        <div class="reviews-filter">
            <label for="review-year">观看年份</label>
            <select id="review-year">
                <option value="">全部</option>
            </select>
        </div>

        <div class="reviews-filter reviews-filter-inline">
            <input id="review-include-unrated" type="checkbox" checked>
            <label for="review-include-unrated">含未看</label>
        </div>

        <div class="reviews-actions">
            <button id="review-reset" type="button">重置</button>
            <span id="review-count" class="reviews-count" aria-live="polite"></span>
        </div>

    </section>

    <article class="reviews-content article-content">
        {{ .Content }}
    </article>
</main>

<script>
    (function () {
        const minRateEl = document.getElementById("review-min-rate");
        const maxRateEl = document.getElementById("review-max-rate");
        const yearEl = document.getElementById("review-year");
        const includeUnratedEl = document.getElementById("review-include-unrated");
        const resetEl = document.getElementById("review-reset");
        const countEl = document.getElementById("review-count");

        const itemTbodies = Array.from(document.querySelectorAll("tbody.review-tbody"));
        const seasonBlocks = Array.from(document.querySelectorAll(".review-season"));

        // 生成“观看年份”下拉（从 data-year 收集）
        if (yearEl) {
            const years = Array.from(new Set(
                itemTbodies.map(x => (x.dataset.year || "").trim()).filter(Boolean)
            )).sort((a, b) => Number(b) - Number(a));

            years.forEach(y => {
                const opt = document.createElement("option");
                opt.value = y;
                opt.textContent = y;
                yearEl.appendChild(opt);
            });
        }

        function apply() {
            const minRate = parseFloat(minRateEl.value);
            const maxRate = parseFloat(maxRateEl.value);
            const year = yearEl.value;
            const includeUnrated = includeUnratedEl.checked;

            let visibleItems = 0;

            itemTbodies.forEach(tbody => {
                const rateRaw = (tbody.dataset.rate || "").trim();
                const yearRaw = (tbody.dataset.year || "").trim();

                const r = parseFloat(rateRaw);
                const hasRate = Number.isFinite(r);

                // 未看：没有 rate（或 rate 不是数字）
                const passUnrated = includeUnrated ? true : hasRate;

                // 评分区间：仅对有评分的条目生效；无评分条目只受“包含未看”控制
                let passRange = true;
                if (hasRate) {
                    const passMin = Number.isFinite(minRate) ? (r >= minRate) : true;
                    const passMax = Number.isFinite(maxRate) ? (r <= maxRate) : true;
                    passRange = passMin && passMax;
                }

                const passYear = year ? (yearRaw === year) : true;

                const ok = passUnrated && passRange && passYear;
                tbody.style.display = ok ? "" : "none";
                if (ok) visibleItems++;
            });

            // 隐藏没有可见条目的 season
            seasonBlocks.forEach(season => {
                const itemsInSeason = Array.from(season.querySelectorAll("tbody.review-tbody"));
                const anyVisible = itemsInSeason.some(t => t.style.display !== "none");
                season.style.display = anyVisible ? "" : "none";
            });

            if (countEl) countEl.textContent = `${visibleItems} / ${itemTbodies.length}`;
        }

        function reset() {
            minRateEl.value = "";
            maxRateEl.value = "";
            yearEl.value = "";
            includeUnratedEl.checked = true;
            apply();
        }

        minRateEl && minRateEl.addEventListener("input", apply);
        maxRateEl && maxRateEl.addEventListener("input", apply);
        yearEl && yearEl.addEventListener("change", apply);
        includeUnratedEl && includeUnratedEl.addEventListener("change", apply);
        resetEl && resetEl.addEventListener("click", reset);

        apply();
    })();
</script>
{{ end }}